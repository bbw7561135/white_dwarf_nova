 subroutine screening (if_screen,e_screen     &
  ,rho,tmp,aa,zz,nin,z1,z2)
   implicit real*8(a-h,o-z)
!
   zsqr=zz**2
   if(if_screen.eq.1) then
     mafgw=0
     shlish=1.d0/3
     facscrn=1.d0
     t13=(tmp/1.d9)**shlish
     r13=rho**shlish
     a13=aa**shlish
     z13=zz**shlish
     e_screen=screen_astra(t13,r13,a13,z13,facscrn,mafgw)
   else
     call new_screen (rho,tmp,aa,zsqr,nin,z1,z2,e_screen)
   endif
!
 end subroutine screening
! ==========================================================
  module screen_par
    real(8),save :: par_elec(9,30)
    real(8),save :: a,b,c,d,e,beta,gamma
    real(8),save :: reva,shlish,c_3,five_3
  end module screen_par
  subroutine new_screen (rho,tmp,a_aver,zsqr,nin,z1,z2,Escreen)
! --------------------  reference ---------------------------------------------------
!   Yakovlev & Shalybkov, Soviet Sci. Rev./E, Astrophys Space Phys. Vol.&,1989,pp.311
! -----------------------------------------------------------------------------------
    use screen_par
    implicit real*8(a-h,o-z)
    save initial_screen
!
    gam(ro6,t8,z)=0.2275*z**five_3/t8*(ro6/2)**shlish
    f0(g,g4)=a*g+4*(b*g4-c/g4)+d*log(g)+e
    f0_low(g)=-c_3*sqrt(g**3)+beta/gamma*g**gamma
    A_f1(iz,x)=par_elec(1,iz)+par_elec(2,iz)*log(1+par_elec(3,iz)/(1+x**2))
    B_f1(iz,x)=par_elec(4,iz)+par_elec(5,iz)*log(1+par_elec(6,iz)/(1+x**2))
    C_f1(iz,x)=par_elec(7,iz)+par_elec(8,iz)*log(1+par_elec(9,iz)/(1+x**2))
    f1(g,iz,xf)=0
!
    data init_screen/0/
! -----------------------------------------------------------------------------------
    if(init_screen.eq.0) then
      init_screen=1
      call screen_init
    endif
! -----------------------------------------------------------------------------------
    t8=tmp/1.d8
    ro6=rho/1.d6
    h_ions=0.d0
    h_elec=0.d0
!
    tlow=2.275d7*zsqr*(ro6/a_aver)**shlish   !!  eq. (12)
!
    if(nin.eq.2) then
! ----------------   two particles reaction ----------------------------
       g1=gam(ro6,t8,z1)
       g14=g1**reva
       g2=gam(ro6,t8,z2)
       g24=g2**reva
       g12=gam(ro6,t8,z1+z2)
       g12_4=g12**reva
       if(tmp.le.tlow) then
! -------------------       strong screening eq. (162)
          h_ions=f0(g1,g14)+f0(g2,g24)-f0(g12,g12_4)
          h_elec=0.d0       !!!!!!!!!!!!!!!!!!!!!!!!!!
       else
!  -----------------------    weak screening  eq. (104)
          h_ions=f0_low(g1)+f0_low(g2)-f0_low(g12)
       endif
!
    else if(nin.eq.3) then
! ----------------   three particles reaction ----------------------------
       g_a=gam(ro6,t8,z1)
       g_a4=g_a**reva
       g3_a=3.d0**five_3*g_a
       g3_a4=g3_a**reva
       if(tmp.le.tlow) then
!       ----------------       strong screening eq. (184)
          h_ions=3*f0(g_a,g_a4)-f0(g3_a,g3_a4)
          h_elec=0.d0      !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
       else
!  -----------------------    weak screening  eq. (104)
          h_ions=3*f0_low(g_a)-f0_low(g3_a)
       endif
    endif
!
    Escreen=exp(h_ions+h_elec)
!
  end subroutine new_screen
! -------------------------------------------------------------------------
  subroutine screen_init
    use screen_par
    implicit real*8(a-h,o-z)
! --------------------------------------------------------------------------
    a=-0.897744d0;b=0.95043d0;c=0.18956d0;d=-0.81487d0;e=-2.5820d0
    beta=0.29341d0; gamma=2.0160d0
    reva=0.25d0; shlish=0.333333333333d0; five_3=1.66666666667d0
    c_3=1.d0/sqrt(3.d0)
! --------------------------------------------------------------------------
    par_elec=reshape((/                                                           &
 0.007924, 0.02610, 0.5280, 0.2020, 0.1069  , 1.616, -0.0293 , -0.08771 , 1.343,  &
  0.01518, 0.04045, 0.6262, 0.2356, 0.02122 , 7.022, -0.05274, -0.01206 , 7.006,  &
  0.02084, 0.03659, 0.8038, 0.2457, 0.01371 , 10.72, -0.05814, -0.007352, 11.71,  &    
  0.02506, 0.03275, 0.9552, 0.2519, 0.01292 , 10.75, -0.06168, -0.007736, 10.38,  &
  0.02836, 0.03000, 1.079 , 0.2565, 0.01238 , 10.75, -0.06452, -0.008038, 9.300,  &
  0.03105, 0.02810, 1.179 , 0.2602, 0.01160 , 10.96, -0.06682, -0.007733, 9.321,  &
  0.03332, 0.02665, 1.263 , 0.2631, 0.01052 , 11.75, -0.06868, -0.007033, 9.991,  &
  0.03528, 0.02563, 1.330 , 0.2654, 0.009349, 13.20, -0.07014, -0.006200, 11.27,  &
  0.03699, 0.02473, 1.390 , 0.2673, 0.008355, 14.69, -0.07134, -0.005464, 12.71,  &
  0.03852, 0.02403, 1.441 , 0.2690, 0.007515, 16.10, -0.07234, -0.004804, 14.48,  &
  0.03990, 0.02332, 1.491 , 0.2703, 0.006840, 17.64, -0.07317, -0.004324, 15.99,  &
  0.04115, 0.02270, 1.536 , 0.2715, 0.006283, 19.22, -0.07388, -0.003926, 17.65,  &
  0.04229, 0.02217, 1.577 , 0.2724, 0.005852, 20.60, -0.07449, -0.003647, 18.85,  &
  0.04334, 0.02165, 1.616 , 0.2733, 0.005523, 21.57, -0.07501, -0.003406, 20.42,  &
  0.04431, 0.02117, 1.654 , 0.2741, 0.005263, 22.30, -0.07548, -0.003247, 21.10,  &
  0.04520, 0.02071, 1.689 , 0.2748, 0.005007, 23.40, -0.07592, -0.003076, 22.41,  &
  0.01604, 0.02033, 1.720 , 0.2755, 0.004857, 23.47, -0.07633, -0.003019, 21.78,  &
  0.04683, 0.01994, 1.753 , 0.2761, 0.004662, 24.45, -0.07668, -0.002894, 22.92,  &
  0.04757, 0.01958, 1.783 , 0.2766, 0.004482, 25.79, -0.07699, -0.002790, 24.00,  &
  0.04826, 0.01924, 1.811 , 0.2771, 0.004357, 25.91, -0.07730, -0.002711, 24.28,  &
  0.04892, 0.01894, 1.838 , 0.2776, 0.004240, 26.17, -0.07760, -0.002654, 24.11,  &
  0.04954, 0.01866, 1.863 , 0.2780, 0.004139, 26.17, -0.07788, -0.002594, 24.24,  &
  0.05013, 0.01838, 1.887 , 0.2784, 0.003993, 27.49, -0.07812, -0.002515, 24.93,  &
  0.05069, 0.01812, 1.910 , 0.2788, 0.003913, 27.36, -0.07835, -0.002465, 25.05,  &
  0.05122, 0.01788, 1.932 , 0.2791, 0.003792, 28.39, -0.07855, -0.002394, 25.79,  &
  0.05173, 0.01765, 1.954 , 0.2794, 0.003625, 31.32, -0.07868, -0.002262, 29.92,  &
  0.05222, 0.01745, 1.973 , 0.2798, 0.003567, 30.09, -0.07896, -0.002235, 27.90,  &
  0.05269, 0.01724, 1.992 , 0.2801, 0.003458, 31.34, -0.07912, -0.002158, 29.51,  &
  0.05314, 0.01704, 2.011 , 0.2803, 0.003377, 31.95, -0.07927, -0.002106, 30.28,  &
  0.05357, 0.01686, 2.028 , 0.2807, 0.003325, 31.28, -0.07947, -0.002082, 29.07/) &
  ,(/9,30/))
! ------------------------------------------------------------
  end subroutine screen_init
! ===============================================================================
!  screen.f90
FUNCTION screen_astra (t13,r13,a13,z13,facscren,mafgw)
  IMPLICIT REAL*8(a-h,o-z)
  !OPTIONAL :: facscren,mafgw
  ! mafgw=0 (default), t13=t9**shlish,r13=rho**shlish,etc... 
  !  salpeter,e.e. and van-horn,m.h. 1969,apj,155,p. 183
  !  t13=(t*1.e-9)**(1/3)  r13=ro**(1/3)  a13=a**(1/3)  z13=z**(1/3)
  f13=1./3.;  f23=2./3.;  f43=4./3.;  f53=5./3.
  f253=2.**f53;  f243=2.**f43;  f223=2.**f23;  cb=1.88d8**f23/1.d9
  azfq=.855/4./(27./4.*3.14**2*1.67e-24*9.e20/137.**2/1.e9/1.38e-16*3.**5)**f13
  cc=.57562*(.5/1.6203d10)**f13
  fttu=38.348**f13;  fus=0.9*(f253-2.d0);  f03=0.3*f253;  f0266=0.266*SQRT(32.)

  gmsv=cc*z13**5*r13/t13**3
  gm32=SQRT(gmsv)**3
  xsv=1.+.3*gmsv+0.266*gm32
  IF(z13==1.25992105) THEN
     screen=2.916d0*gmsv+LOG((1.d0+1.87d0*gmsv+4.15d0*gm32)/xsv**3)
  ELSE
!xxxxx    IF(.NOT.PRESENT(mafgw).OR.(PRESENT(mafgw).AND.mafgw==0)) THEN
     IF(mafgw.le.0) THEN
        uszr=fus*gmsv
        frr=(1.+f03*gmsv+f0266*gm32)/(1.+.3*gmsv+.266*gm32)**2
        beta=uszr/(z13**4*a13*fttu)*t13
        corb=1.-2.15*beta**2*(1.+22.2*beta**6)/(1.+17.1*beta**3)
        screen=corb*uszr+LOG(frr)
    ELSE
      SELECT CASE(mafgw)
      CASE(1)
        screen=0.624*z13*(cb*r13/a13/t13**3*(z13**5*(f253-2.)+0.316*z13**5*(f243-2.))+0.737/z13**5*(f223-2.))
      CASE(2)
        screen=1.25*gmsv-azfq*t13*gmsv**2
      CASE default
        STOP 'wrong mafgw'
      END SELECT
    END IF
  END IF
  screen_astra=EXP(screen)
  screen_astra=screen_astra*facscren
!xxxxx  IF(PRESENT(facscren)) screen_astra=screen_astra*facscren
END FUNCTION screen_astra
